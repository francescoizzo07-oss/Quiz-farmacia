<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulatore Farmaceutico</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #2f3e4e;
  color: #fff;
}
.container {
  max-width: 720px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #3b4a5a;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
h2, h3 {
  margin-top: 0;
}
label {
  display: block;
  margin: 10px 0;
}
button {
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
}
button.primary {
  width: 100%;
  background: #7fb7ff;
  color: #000;
  font-weight: bold;
}
.option {
  background: #fff;
  color: #000;
  padding: 14px;
  border-radius: 10px;
  margin: 10px 0;
}
.option.correct { background: #9be7a1; }
.option.wrong { background: #f7a3a3; }

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.bottombar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1f2a36;
  display: flex;
  justify-content: space-between;
  padding: 10px 20px;
}
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background: #fff;
  color: #000;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
}
textarea {
  width: 100%;
  min-height: 100px;
}
</style>
</head>

<body>

<!-- MENU -->
<div id="menu" class="container">
  <h2>Configurazione</h2>

<div class="card">
  <h3>Livello di preparazione</h3>

  <label><input type="checkbox" value="le_sai"> Le sai <span id="c_le_sai">0</span></label>
  <label><input type="checkbox" value="ancora_sforzo"> Ancora un piccolo sforzo <span id="c_sforzo">0</span></label>
  <label><input type="checkbox" value="ripetile"> Ripetile <span id="c_ripetile">0</span></label>
  <label><input type="checkbox" value="non_le_sai"> Non le sai <span id="c_non_le_sai">0</span></label>
  <label><input type="checkbox" value="non_risposte" checked> Non risposte <span id="c_non_risposte">0</span></label>
  <label><input type="checkbox" value="tutte"> Tutte <span id="c_tutte">0</span></label>
</div>

<div class="card">
  <h3>Ordinamento dei quiz</h3>

  <strong>Domande</strong>
  <label><input type="radio" name="orderQuestions" value="random" checked> Casuale</label>
  <label><input type="radio" name="orderQuestions" value="alphabetic"> Alfabetico</label>
  <label><input type="radio" name="orderQuestions" value="official"> Ufficiale</label>

  <br>

  <strong>Risposte</strong>
  <label><input type="radio" name="orderAnswers" value="random" checked> Casuale</label>
  <label><input type="radio" name="orderAnswers" value="official"> Ufficiale</label>
  <label><input type="radio" name="orderAnswers" value="onlyCorrect"> Solo risposta esatta</label>
</div>

  <div class="card">
    <h3>Modalit√†</h3>
    <label><input type="radio" name="mode" value="study" checked> Esercizio</label>
    <label><input type="radio" name="mode" value="exam"> Simulazione esame</label>
  </div>

  <button class="primary" onclick="start()">AVVIA</button>
</div>

<!-- QUIZ -->
<div id="quiz" class="container" style="display:none">

  <div class="topbar">
    <button onclick="goMenu()">‚¨ÖÔ∏è</button>
    <div id="status"></div>
  </div>

  <h3 id="progress"></h3>
  <div id="question"></div>
  <div id="options"></div>
</div>

<div class="bottombar" id="nav" style="display:none">
  <button onclick="prev()">‚¨ÖÔ∏è</button>
  <button onclick="openNote()">üìù</button>
  <button onclick="next()">‚û°Ô∏è</button>
</div>

<!-- NOTE -->
<div class="modal" id="noteModal">
  <div class="modal-content">
    <h3>Nota personale</h3>
    <textarea id="noteBox"></textarea>
    <button onclick="saveNote()">Salva</button>
    <button onclick="deleteNote()">Cancella</button>
    <button onclick="closeNote()">Torna alla domanda</button>
  </div>
</div>

<script>
/***********************
 * COSTANTI E STATO
 ***********************/
const SAVE_KEY = "quiz_progress_v1";
const SIMULATION_LIMIT = 100;
const SIMULATION_TIME = 30 * 60; // 30 minuti

let mode = "exercise"; // exercise | simulation
let questionsPool = [];
let currentIndex = 0;
let answers = {};      // { questionId: selectedIndex }
let notes = {};        // { questionId: "testo nota" }
let correctCount = 0;
let wrongCount = 0;
let timer = null;
let timeLeft = SIMULATION_TIME;

/***********************
 * AVVIO
 ***********************/
function startQuiz(selectedMode, orderQuestions, orderAnswers) {
  mode = selectedMode;

  // reset contatori
  correctCount = 0;
  wrongCount = 0;

  // carica domande
  questionsPool = [...questions];

  if (mode === "simulation") {
    shuffleArray(questionsPool);
    questionsPool = questionsPool.slice(0, SIMULATION_LIMIT);
    shuffleAnswersAll();
    startTimer();
  } else {
    if (orderQuestions === "random") shuffleArray(questionsPool);
    if (orderAnswers === "random") shuffleAnswersAll();

    const resumed = loadProgress();
    if (!resumed) {
      currentIndex = 0;
      answers = {};
      notes = {};
    }
  }

  renderQuestion();
}

/***********************
 * RENDER DOMANDA
 ***********************/
function renderQuestion() {
  const q = questionsPool[currentIndex];
  if (!q) return;

  updateCounters();

  document.getElementById("questionText").innerText = q.text;

  const answersBox = document.getElementById("answers");
  answersBox.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.className = "answer-btn";
    btn.innerText = opt;

    if (answers[q.id] !== undefined) {
      if (i === q.correct) btn.classList.add("correct");
      if (i === answers[q.id] && i !== q.correct) btn.classList.add("wrong");
      btn.disabled = true;
    }

    btn.onclick = () => selectAnswer(i);
    answersBox.appendChild(btn);
  });

  saveProgress();
}

/***********************
 * RISPOSTA
 ***********************/
function selectAnswer(index) {
  const q = questionsPool[currentIndex];
  if (answers[q.id] !== undefined) return;

  answers[q.id] = index;

  if (index === q.correct) {
    correctCount++;
  } else {
    wrongCount++;
  }

  renderQuestion();
}

/***********************
 * NAVIGAZIONE
 ***********************/
function nextQuestion() {
  if (currentIndex < questionsPool.length - 1) {
    currentIndex++;
    renderQuestion();
  }
}

function prevQuestion() {
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion();
  }
}

/***********************
 * MENU
 ***********************/
function goToMenu() {
  saveProgress();
  stopTimer();
  document.getElementById("quizScreen").style.display = "none";
  document.getElementById("menuScreen").style.display = "block";
}

/***********************
 * CONTATORI
 ***********************/
function updateCounters() {
  document.getElementById("correctCounter").innerText = correctCount;
  document.getElementById("wrongCounter").innerText = wrongCount;
}

/***********************
 * NOTE
 ***********************/
function openNote() {
  const q = questionsPool[currentIndex];
  const text = notes[q.id] || "";
  document.getElementById("noteText").value = text;
  document.getElementById("noteModal").style.display = "block";
}

function saveNote() {
  const q = questionsPool[currentIndex];
  const value = document.getElementById("noteText").value.trim();

  if (value === "") {
    delete notes[q.id];
  } else {
    notes[q.id] = value;
  }

  saveProgress();
  closeNote();
}

function deleteNote() {
  const q = questionsPool[currentIndex];
  delete notes[q.id];
  saveProgress();
  closeNote();
}

function closeNote() {
  document.getElementById("noteModal").style.display = "none";
}

/***********************
 * TIMER SIMULAZIONE
 ***********************/
function startTimer() {
  timeLeft = SIMULATION_TIME;
  updateTimer();

  timer = setInterval(() => {
    timeLeft--;
    updateTimer();
    if (timeLeft <= 0) endSimulation();
  }, 1000);
}

function stopTimer() {
  if (timer) clearInterval(timer);
}

function updateTimer() {
  const min = Math.floor(timeLeft / 60);
  const sec = timeLeft % 60;
  document.getElementById("timer").innerText =
    `${min}:${sec.toString().padStart(2, "0")}`;
}

function endSimulation() {
  stopTimer();
  alert(`Simulazione terminata\nCorrette: ${correctCount}\nSbagliate: ${wrongCount}`);
  goToMenu();
}

/***********************
 * SALVATAGGIO / RIPRESA
 ***********************/
function saveProgress() {
  if (mode === "simulation") return;

  const data = {
    currentIndex,
    answers,
    notes,
    mode
  };

  localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function loadProgress() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;

  const data = JSON.parse(raw);
  if (data.mode !== "exercise") return false;

  currentIndex = data.currentIndex || 0;
  answers = data.answers || {};
  notes = data.notes || {};
  return true;
}

/***********************
 * UTILIT√Ä
 ***********************/
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function shuffleAnswersAll() {
  questionsPool.forEach(q => {
    const correctText = q.options[q.correct];
    shuffleArray(q.options);
    q.correct = q.options.indexOf(correctText);
  });
}
</script>

</body>
</html>
