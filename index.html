<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulatore Farmaceutico</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c7be5">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 12px;
  background: #f4f4f4;
}
#config, #quiz {
  max-width: 720px;
  margin: auto;
}
.option {
  background: #fff;
  padding: 14px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  padding: 12px;
  width: 100%;
  margin-top: 10px;
  font-size: 16px;
}
textarea {
  width: 100%;
  min-height: 80px;
}
.nav {
  display: flex;
  gap: 10px;
}
.counter {
  margin: 10px 0;
  font-weight: bold;
}
</style>
</head>

<body onload="initApp()">

<!-- CONFIG -->
<div id="config">
  <h2>Menu principale</h2>

  <h3>Livello</h3>
  <label><input type="checkbox" value="le_sai"> Le sai (<span id="c_le_sai"></span>)</label><br>
  <label><input type="checkbox" value="ancora_sforzo"> Ancora un piccolo sforzo (<span id="c_sforzo"></span>)</label><br>
  <label><input type="checkbox" value="ripetile"> Ripetile (<span id="c_ripetile"></span>)</label><br>
  <label><input type="checkbox" value="non_le_sai"> Non le sai (<span id="c_non_le_sai"></span>)</label><br>
  <label><input type="checkbox" value="non_risposta"> Non risposte (<span id="c_non_risposta"></span>)</label><br>
  <label><input type="checkbox" value="tutte"> Tutte (<span id="c_tutte"></span>)</label>

  <button onclick="startStudy()">ğŸ“˜ Avvia Studio</button>
  <button onclick="startExam()">ğŸ Simulazione Concorso</button>
</div>

<!-- QUIZ -->
<div id="quiz" style="display:none">
  <button onclick="goToMenu()">ğŸ  Menu</button>

  <div class="counter">
    âœ”ï¸ <span id="okCount">0</span> |
    âŒ <span id="koCount">0</span>
  </div>

  <div id="quiz-header"></div>
  <div id="quiz-question"></div>
  <div id="quiz-options"></div>

  <div class="nav">
    <button onclick="prevQuestion()">â¬…ï¸ Indietro</button>
    <button onclick="nextQuestion()">â¡ï¸ Avanti</button>
  </div>

  <h4>ğŸ“ Nota personale</h4>
  <textarea id="noteBox" placeholder="Scrivi una nota per questa domanda..."></textarea>
  <button onclick="saveCurrentNote()">ğŸ’¾ Salva nota</button>
  <button onclick="deleteCurrentNote()">ğŸ—‘ Cancella nota</button>
</div>

<script>
// ===== DATABASE DI TEST =====
const database = [
  { id:1, q:"Il paracetamolo Ã¨:", options:["Antibiotico","Analgesico","Antivirale"], a:1 },
  { id:2, q:"Il diclofenac Ã¨ un:", options:["Oppioide","FANS","Cortisonico"], a:1 },
  { id:3, q:"Vitamina liposolubile:", options:["Vitamina C","Vitamina B12","Vitamina A"], a:2 }
];

database.forEach(q=>{
  q.stats={seen:0,correct:0,wrong:0,level:"non_risposta"};
});

// ===== VARIABILI =====
let quizQuestions=[], currentIndex=0, studyMode=true;
let sessionCorrect=0, sessionWrong=0, answered={};

const NOTES_KEY="quizNotes";
const STATS_KEY="quizStats";

// ===== INIT =====
function initApp(){
  loadStats();
  updateCounters();
}

// ===== STUDIO =====
function startStudy(){
  resetSession();
  const levels=[...document.querySelectorAll("input[type=checkbox]:checked")].map(c=>c.value);
  quizQuestions=levels.includes("tutte")||levels.length===0?[...database]:
    database.filter(q=>levels.includes(q.stats.level));
  shuffle(quizQuestions);
  currentIndex=0;
  studyMode=true;
  showQuiz();
}

// ===== QUIZ =====
function showQuiz(){
  document.getElementById("config").style.display="none";
  document.getElementById("quiz").style.display="block";
  loadQuestion();
}

function loadQuestion(){
  const q=quizQuestions[currentIndex];
  document.getElementById("quiz-header").innerText=
    `Domanda ${currentIndex+1}/${quizQuestions.length}`;
  document.getElementById("quiz-question").innerHTML=`<b>${q.q}</b>`;
  const opts=document.getElementById("quiz-options");
  opts.innerHTML="";
  q.options.forEach((o,i)=>{
    const d=document.createElement("div");
    d.className="option";
    d.innerText=o;
    d.onclick=()=>answer(q,i,d);
    opts.appendChild(d);
  });
  document.getElementById("noteBox").value=loadNote(q.id);
}

function answer(q,i,el){
  if(answered[q.id])return;
  answered[q.id]=true;
  const correct=i===q.a;
  if(correct){el.style.background="#c8f7c5";sessionCorrect++;}
  else{el.style.background="#f7c5c5";sessionWrong++;}
  updateSessionCounter();
  if(studyMode)updateStats(q,correct);
}

function prevQuestion(){ if(currentIndex>0){currentIndex--;loadQuestion();} }
function nextQuestion(){ if(currentIndex<quizQuestions.length-1){currentIndex++;loadQuestion();} }

// ===== CONTATORI =====
function resetSession(){
  sessionCorrect=0;sessionWrong=0;answered={};
  updateSessionCounter();
}
function updateSessionCounter(){
  document.getElementById("okCount").innerText=sessionCorrect;
  document.getElementById("koCount").innerText=sessionWrong;
}

// ===== STATISTICHE =====
function updateStats(q,correct){
  q.stats.seen++;
  if(correct){q.stats.correct++;q.stats.level=q.stats.correct>=2?"le_sai":"ancora_sforzo";}
  else{q.stats.wrong++;q.stats.level=q.stats.level==="le_sai"?"ripetile":"non_le_sai";}
  saveStats();
}
function saveStats(){
  const s={};database.forEach(q=>s[q.id]=q.stats);
  localStorage.setItem(STATS_KEY,JSON.stringify(s));
}
function loadStats(){
  const s=JSON.parse(localStorage.getItem(STATS_KEY));
  if(!s)return;
  database.forEach(q=>{if(s[q.id])q.stats=s[q.id];});
}
function updateCounters(){
  document.getElementById("c_le_sai").innerText=database.filter(q=>q.stats.level==="le_sai").length;
  document.getElementById("c_sforzo").innerText=database.filter(q=>q.stats.level==="ancora_sforzo").length;
  document.getElementById("c_ripetile").innerText=database.filter(q=>q.stats.level==="ripetile").length;
  document.getElementById("c_non_le_sai").innerText=database.filter(q=>q.stats.level==="non_le_sai").length;
  document.getElementById("c_non_risposta").innerText=database.filter(q=>q.stats.level==="non_risposta").length;
  document.getElementById("c_tutte").innerText=database.length;
}

// ===== NOTE =====
function saveNote(id){
  const n=JSON.parse(localStorage.getItem(NOTES_KEY))||{};
  n[id]=document.getElementById("noteBox").value;
  localStorage.setItem(NOTES_KEY,JSON.stringify(n));
}
function loadNote(id){
  const n=JSON.parse(localStorage.getItem(NOTES_KEY))||{};
  return n[id]||"";
}
function deleteCurrentNote(){
  const id=quizQuestions[currentIndex].id;
  const n=JSON.parse(localStorage.getItem(NOTES_KEY))||{};
  delete n[id];
  localStorage.setItem(NOTES_KEY,JSON.stringify(n));
  document.getElementById("noteBox").value="";
}

// ===== MENU =====
function goToMenu(){ location.reload(); }

// ===== UTILS =====
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
</script>

<script>
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
